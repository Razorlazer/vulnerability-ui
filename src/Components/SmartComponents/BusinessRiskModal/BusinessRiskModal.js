import { Button, Form, FormGroup, Modal, Radio, Stack, StackItem, TextInput } from '@patternfly/react-core';
import { addNotification } from '@redhat-cloud-services/frontend-components-notifications';
import propTypes from 'prop-types';
import React, { useEffect, useState } from 'react';
import { connect } from 'react-redux';
import { setBusinessRisk } from '../../../Helpers/APIHelper';
import { businessRiskOptions } from '../../../Helpers/constants';

export const BusinessRiskModal = ({ cves, updateRef, ...props }) => {
    const [cveList, setCveList] = useState(cves);
    const [businessRiskId, setBusinessRiskId] = useState('0');
    const [label, setLabel] = useState();

    useEffect(() => {
        getDefaultBusinessRisk(), getDefaultLabel();
    }, [cves]);
    useEffect(getDefaultLabel, [cves]);

    const createNotification = () => {
        return props.addNotification({
            variant: 'success',
            title: `Business risk updated for ${cveList.length} CVEs`
        });
    };

    const handleOnRadioChange = (_, event) => {
        const { value } = event.currentTarget;
        setBusinessRiskId(value);
    };

    const handleOnLabelChange = value => {
        setLabel(value);
    };

    const handleClose = () => {
        setCveList(undefined);
    };

    const handleSave = () => {
        setBusinessRisk({
            business_risk_id: parseInt(businessRiskId),
            cve: cveList.map(item => item.id),
            business_risk_text: label
        })
        .then(updateRef)
        .then(() => createNotification());

        handleClose();
    };

    function getDefaultBusinessRisk() {
        setBusinessRiskId((cveList && cveList.length === 1 && cveList[0].business_risk_id.toString()) || '0');
    }

    function getDefaultLabel() {
        setLabel((cveList && cveList.length === 1 && cveList[0].justification) || '');
    }

    const modal = open && (
        <Modal
            isSmall
            title="Edit business risk"
            isOpen={Boolean(cveList)}
            onClose={handleClose}
            actions={[
                <Button key="save" variant="primary" onClick={handleSave}>
                    Save
                </Button>,
                <Button key="cancel" variant="secondary" onClick={handleClose}>
                    Cancel
                </Button>
            ]}
        >
            <Stack gutter={'md'}>
                <StackItem>Business risk can be used to mark which CVEs are most important to you business.</StackItem>
                <StackItem>
                    <Form>
                        <FormGroup label="Business risk" fieldId={'businessRiskId'}>
                            {businessRiskOptions.map(item => (
                                <Radio
                                    value={item.value}
                                    isChecked={businessRiskId === item.value}
                                    onChange={handleOnRadioChange}
                                    label={item.label}
                                    key={item.value}
                                    id={item.value}
                                    name={item.label}
                                    aria-label={item.label}
                                />
                            ))}
                        </FormGroup>
                        <FormGroup label="Justification" fieldId={'label'}>
                            <TextInput type="text" onChange={handleOnLabelChange} value={label} aria-label={'justification'} />
                        </FormGroup>
                    </Form>
                </StackItem>
            </Stack>
        </Modal>
    );

    return <React.Fragment>{modal}</React.Fragment>;
};

BusinessRiskModal.propTypes = {
    open: propTypes.bool,
    onClose: propTypes.func,
    cves: propTypes.array,
    updateRef: propTypes.func,
    addNotification: propTypes.func
};

const mapDispatchToProps = dispatch => {
    return {
        addNotification: data => dispatch(addNotification(data))
    };
};

export default connect(
    null,
    mapDispatchToProps
)(BusinessRiskModal);
